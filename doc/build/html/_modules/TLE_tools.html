
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TLE_tools &#8212; SORTS++ 3.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SORTS++ 3.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for TLE_tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Collection of useful functions for handling TLE&#39;s.</span>


<span class="sd">**Links:**</span>
<span class="sd">  * `AIAA 2006-6753 &lt;https://celestrak.com/publications/AIAA/2006-6753/&gt;`_</span>
<span class="sd">  * `python-skyfield &lt;https://github.com/skyfielders/python-skyfield&gt;`_</span>


<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sgp4.io</span> <span class="k">import</span> <span class="n">twoline2rv</span>
<span class="kn">import</span> <span class="nn">dpt_tools</span> <span class="k">as</span> <span class="nn">dpt</span>


<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">propagator_sgp4</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">propagator_sgp4</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="TLE_propagation_TEME"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.TLE_propagation_TEME">[docs]</a><span class="k">def</span> <span class="nf">TLE_propagation_TEME</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">jd_ut1</span><span class="p">,</span> <span class="n">wgs</span> <span class="o">=</span> <span class="s1">&#39;72&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert Two-line element to TEME coordinates at a specific Julian date.</span>
<span class="sd">    </span>
<span class="sd">    :param str line1: TLE line 1</span>
<span class="sd">    :param str line2: TLE line 2</span>
<span class="sd">    :param float/numpy.ndarray jd_ut1: Julian Date UT1 to propagate TLE to.</span>
<span class="sd">    :param str wgs: The used WGS standard, options are :code:`&#39;72&#39;` or :code:`&#39;84&#39;`.</span>

<span class="sd">    :return: (6,len(jd_ut1)) numpy.ndarray of Cartesian states [SI units]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">wgs</span> <span class="o">==</span> <span class="s1">&#39;72&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sgp4.earth_gravity</span> <span class="k">import</span> <span class="n">wgs72</span> <span class="k">as</span> <span class="n">wgs_sys</span>
    <span class="k">elif</span> <span class="n">wgs</span> <span class="o">==</span> <span class="s1">&#39;84&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sgp4.earth_gravity</span> <span class="k">import</span> <span class="n">wgs84</span> <span class="k">as</span> <span class="n">wgs_sys</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WGS standard &quot;</span><span class="si">{}</span><span class="s1">&quot; not recognized.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wgs</span><span class="p">))</span>

    <span class="n">satellite</span> <span class="o">=</span> <span class="n">twoline2rv</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">wgs_sys</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jd_ut1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only 1-D date array allowed: jd_ut1.shape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jd_ut1</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">jd_ut1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jd_ut1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">jd_ut1</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">jdi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jd_ut1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">usec</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">npdt2date</span><span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">mjd2npdt</span><span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">jd_to_mjd</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">[</span><span class="n">jdi</span><span class="p">])))</span>

        <span class="n">position</span><span class="p">,</span> <span class="n">velocity</span> <span class="o">=</span> <span class="n">satellite</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span>
            <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
            <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span>
            <span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="p">,</span>
            <span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span>
            <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">,</span>
            <span class="n">second</span><span class="o">=</span><span class="n">second</span> <span class="o">+</span> <span class="n">usec</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">*=</span> <span class="mf">1e3</span> <span class="c1">#km to m</span>

        <span class="n">states</span><span class="p">[:,</span><span class="n">jdi</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">return</span> <span class="n">states</span></div>

<div class="viewcode-block" id="tle_npdt"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.tle_npdt">[docs]</a><span class="k">def</span> <span class="nf">tle_npdt</span><span class="p">(</span><span class="n">line1</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line1</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">year</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="mi">1900</span> <span class="o">+</span> <span class="n">year</span>

    <span class="n">yearday_frac</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line1</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">yearday_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">yearday_frac</span><span class="o">*</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span><span class="o">*</span><span class="mf">1e6</span><span class="p">),</span><span class="s1">&#39;us&#39;</span><span class="p">)</span>

    <span class="n">np_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-01-01T00:00&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="s1">&#39;us&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">yearday_dt</span>
    <span class="k">return</span> <span class="n">np_date</span></div>


<div class="viewcode-block" id="tle_jd"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.tle_jd">[docs]</a><span class="k">def</span> <span class="nf">tle_jd</span><span class="p">(</span><span class="n">line1</span><span class="p">):</span>
    <span class="n">np_date</span> <span class="o">=</span> <span class="n">tle_npdt</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dpt</span><span class="o">.</span><span class="n">mjd_to_jd</span><span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">npdt2mjd</span><span class="p">(</span><span class="n">np_date</span><span class="p">))</span></div>


<div class="viewcode-block" id="tle_date"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.tle_date">[docs]</a><span class="k">def</span> <span class="nf">tle_date</span><span class="p">(</span><span class="n">line1</span><span class="p">):</span>
    <span class="n">np_date</span> <span class="o">=</span> <span class="n">tle_npdt</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dpt</span><span class="o">.</span><span class="n">npdt2date</span><span class="p">(</span><span class="n">np_date</span><span class="p">)</span></div>


<div class="viewcode-block" id="TLE_to_TEME"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.TLE_to_TEME">[docs]</a><span class="k">def</span> <span class="nf">TLE_to_TEME</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">wgs</span> <span class="o">=</span> <span class="s1">&#39;72&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert Two-line element to TEME coordinates and a Julian date epoch.</span>

<span class="sd">    Here it is assumed that the TEME frame uses:</span>
<span class="sd">    The Cartesian coordinates produced by the SGP4/SDP4 model have their z</span>
<span class="sd">    axis aligned with the true (instantaneous) North pole and the x axis</span>
<span class="sd">    aligned with the mean direction of the vernal equinox (accounting for</span>
<span class="sd">    precession but not nutation). This actually makes sense since the</span>
<span class="sd">    observations are collected from a network of sensors fixed to the</span>
<span class="sd">    earth&#39;s surface (and referenced to the true equator) but the position</span>
<span class="sd">    of the earth in inertial space (relative to the vernal equinox) must</span>
<span class="sd">    be estimated.</span>
<span class="sd">    </span>
<span class="sd">    :param str line1: TLE line 1</span>
<span class="sd">    :param str line2: TLE line 2</span>
<span class="sd">    :param str wgs: The used WGS standard, options are :code:`&#39;72&#39;` or :code:`&#39;84&#39;`.</span>

<span class="sd">    :return: tuple of (6-D numpy.ndarray Cartesian state [SI units], epoch in Julian Date UT1)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">usec</span> <span class="o">=</span> <span class="n">tle_date</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">wgs</span> <span class="o">==</span> <span class="s1">&#39;72&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sgp4.earth_gravity</span> <span class="k">import</span> <span class="n">wgs72</span> <span class="k">as</span> <span class="n">wgs_sys</span>
    <span class="k">elif</span> <span class="n">wgs</span> <span class="o">==</span> <span class="s1">&#39;84&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sgp4.earth_gravity</span> <span class="k">import</span> <span class="n">wgs84</span> <span class="k">as</span> <span class="n">wgs_sys</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WGS standard &quot;</span><span class="si">{}</span><span class="s1">&quot; not recognized.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wgs</span><span class="p">))</span>

    <span class="n">satellite</span> <span class="o">=</span> <span class="n">twoline2rv</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">wgs_sys</span><span class="p">)</span>
    <span class="n">position</span><span class="p">,</span> <span class="n">velocity</span> <span class="o">=</span> <span class="n">satellite</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span>
        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
        <span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">,</span>
        <span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="p">,</span>
        <span class="n">hour</span><span class="o">=</span><span class="n">hour</span><span class="p">,</span>
        <span class="n">minute</span><span class="o">=</span><span class="n">minute</span><span class="p">,</span>
        <span class="n">second</span><span class="o">=</span><span class="n">second</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">*=</span> <span class="mf">1e3</span> <span class="c1">#km to m</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">tle_jd</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span></div>


<div class="viewcode-block" id="theta_GMST1982"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.theta_GMST1982">[docs]</a><span class="k">def</span> <span class="nf">theta_GMST1982</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the angle of Greenwich Mean Standard Time 1982 given the JD.</span>
<span class="sd">    This angle defines the difference between the idiosyncratic True</span>
<span class="sd">    Equator Mean Equinox (TEME) frame of reference used by SGP4 and the</span>
<span class="sd">    more standard Pseudo Earth Fixed (PEF) frame of reference.</span>


<span class="sd">    *Reference:* AIAA 2006-6753 Appendix C.</span>

<span class="sd">    Original work Copyright (c) 2013-2018 Brandon Rhodes under the MIT license</span>
<span class="sd">    Modified work Copyright (c) 2019 Daniel Kastinen</span>

<span class="sd">    :param float jd_ut1: UT1 Julian date.</span>
<span class="sd">    :returns: tuple of (Earth rotation [rad], Earth angular velocity [rad/day])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_second</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.0</span> <span class="o">*</span> <span class="mf">60.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span>

    <span class="n">T0</span> <span class="o">=</span> <span class="mf">2451545.0</span>

    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">jd_ut1</span> <span class="o">-</span> <span class="n">T0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36525.0</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">67310.54841</span> <span class="o">+</span> <span class="p">(</span><span class="mf">8640184.812866</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.093104</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mf">6.2e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">dg</span> <span class="o">=</span> <span class="mf">8640184.812866</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.093104</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mf">6.2e-6</span> <span class="o">*</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">jd_ut1</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">_second</span> <span class="o">%</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">theta_dot</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dg</span> <span class="o">*</span> <span class="n">_second</span> <span class="o">/</span> <span class="mf">36525.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">theta_dot</span></div>

<span class="c1">#when imported, get the full real path for the data loading</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_base_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">_base_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="get_IERS_EOP"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.get_IERS_EOP">[docs]</a><span class="k">def</span> <span class="nf">get_IERS_EOP</span><span class="p">(</span><span class="n">fname</span> <span class="o">=</span> <span class="n">_base_path</span> <span class="o">+</span> <span class="s1">&#39;data/eopc04_IAU2000.62-now&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads the IERS EOP data into memory.</span>

<span class="sd">    Note: Column descriptions are hard-coded in the function and my change if standard IERS format is changed.</span>

<span class="sd">    :param str fname: path to input IERS data file.</span>
<span class="sd">    :return: tuple of (numpy.ndarray, list of column descriptions)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Date year (0h UTC)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Date month (0h UTC)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Date day (0h UTC)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MJD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;x (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;y (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UT1-UTC (s)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LOD (s)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dX (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dY (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;x Err (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;y Err (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UT1-UTC Err (s)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LOD Err (s)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dX Err (arcseconds)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dY Err (arcseconds)&#39;</span><span class="p">,</span>
    <span class="p">]</span>



    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span></div>


<span class="n">_EOP_data</span><span class="p">,</span> <span class="n">_EOP_header</span> <span class="o">=</span> <span class="n">get_IERS_EOP</span><span class="p">()</span>

<span class="n">_mjd_const</span> <span class="o">=</span> <span class="mf">2400000.5</span>
<span class="n">_arcseconds_to_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mf">60.0</span><span class="o">*</span><span class="mf">60.0</span><span class="o">*</span><span class="mf">180.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_jd_rows</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">):</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">jd_ut1</span> <span class="o">-</span> <span class="n">_mjd_const</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_EOP_data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mjd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-1</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No EOP data available for JD: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">))</span>
    <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_EOP_data</span><span class="p">[</span><span class="n">row</span><span class="p">:(</span><span class="n">row</span><span class="o">+</span><span class="mi">2</span><span class="p">),:]</span>

<span class="k">def</span> <span class="nf">_interp_rows</span><span class="p">(</span><span class="n">_jd_ut1</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_jd_ut1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_jd_ut1</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only numpy.ndarray and float input allowed&#39;</span><span class="p">)</span>

        <span class="n">_jd_ut1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_jd_ut1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">_jd_ut1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_jd_ut1</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only 1D input arrays allowed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_jd_ut1</span> <span class="o">=</span> <span class="n">_jd_ut1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">_jd_ut1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">jdi</span><span class="p">,</span> <span class="n">jd_ut1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_jd_ut1</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">_get_jd_rows</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">jd_ut1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">jdi</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">]</span><span class="o">*</span><span class="n">frac</span>

    <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="get_DUT"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.get_DUT">[docs]</a><span class="k">def</span> <span class="nf">get_DUT</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the Difference UT between UT1 and UTC, :math:`DUT1 = UT1 - UTC`. This function interpolates between data given by IERS.</span>
<span class="sd">    </span>
<span class="sd">    :param float/numpy.ndarray jd_ut1: Input Julian date in UT1.</span>
<span class="sd">    :return: DUT</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_interp_rows</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_Polar_Motion"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.get_Polar_Motion">[docs]</a><span class="k">def</span> <span class="nf">get_Polar_Motion</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the Polar motion coefficients :math:`x_p` and :math:`y_p` used in EOP. This function interpolates between data given by IERS.</span>
<span class="sd">    </span>
<span class="sd">    :param float/numpy.ndarray jd_ut1: Input Julian date in UT1.</span>
<span class="sd">    :return: :math:`x_p` as column 0 and :math:`y_p` as column 1</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">_interp_rows</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="n">_arcseconds_to_rad</span></div>



<div class="viewcode-block" id="TEME_to_ITRF"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.TEME_to_ITRF">[docs]</a><span class="k">def</span> <span class="nf">TEME_to_ITRF</span><span class="p">(</span><span class="n">TEME</span><span class="p">,</span> <span class="n">jd_ut1</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert TEME position and velocity into standard ITRS coordinates.</span>
<span class="sd">    This converts a position and velocity vector in the idiosyncratic</span>
<span class="sd">    True Equator Mean Equinox (TEME) frame of reference used by the SGP4</span>
<span class="sd">    theory into vectors into the more standard ITRS frame of reference.</span>

<span class="sd">    *Reference:* AIAA 2006-6753 Appendix C.</span>

<span class="sd">    Original work Copyright (c) 2013-2018 Brandon Rhodes under the MIT license</span>
<span class="sd">    Modified work Copyright (c) 2019 Daniel Kastinen</span>

<span class="sd">    Since TEME uses the instantaneous North pole and mean direction</span>
<span class="sd">    of the Vernal equinox, a simple GMST and polar motion transformation will move to ITRS.</span>

<span class="sd">    # TODO: There is some ambiguity about if this is ITRS00 or something else? I dont know.</span>

<span class="sd">    :param numpy.ndarray TEME: 6-D state vector in TEME frame given in SI-units.</span>
<span class="sd">    :param float jd_ut1: UT1 Julian date.</span>
<span class="sd">    :param float xp: Polar motion constant for rotation around x axis</span>
<span class="sd">    :param float yp: Polar motion constant for rotation around y axis</span>
<span class="sd">    :return: ITRF 6-D state vector given in SI-units.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TEME</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rTEME</span> <span class="o">=</span> <span class="n">TEME</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">vTEME</span> <span class="o">=</span> <span class="n">TEME</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rTEME</span> <span class="o">=</span> <span class="n">TEME</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">vTEME</span> <span class="o">=</span> <span class="n">TEME</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">*</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span>

    <span class="n">theta</span><span class="p">,</span> <span class="n">theta_dot</span> <span class="o">=</span> <span class="n">theta_GMST1982</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">theta_dot</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">angular_velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="o">-</span><span class="n">theta_dot</span><span class="p">])</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_z</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rTEME</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rPEF</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rTEME</span><span class="p">)</span>
        <span class="n">vPEF</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vTEME</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">angular_velocity</span><span class="p">,</span> <span class="n">rPEF</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rPEF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij...,j...-&gt;i...&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">rTEME</span><span class="p">)</span>
        <span class="n">vPEF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij...,j...-&gt;i...&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">vTEME</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span>
            <span class="n">angular_velocity</span><span class="p">,</span> <span class="n">rPEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
        <span class="n">rITRF</span> <span class="o">=</span> <span class="n">rPEF</span>
        <span class="n">vITRF</span> <span class="o">=</span> <span class="n">vPEF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_x</span><span class="p">(</span><span class="n">yp</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_y</span><span class="p">(</span><span class="n">xp</span><span class="p">))</span>
        <span class="n">rITRF</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rPEF</span><span class="p">)</span>
        <span class="n">vITRF</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vPEF</span><span class="p">)</span>

    <span class="n">ITRF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">TEME</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TEME</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TEME</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ITRF</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rITRF</span>
        <span class="n">ITRF</span><span class="p">[</span><span class="mi">3</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">vITRF</span><span class="o">/</span><span class="p">(</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ITRF</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rITRF</span>
        <span class="n">ITRF</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vITRF</span><span class="o">/</span><span class="p">(</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ITRF</span></div>



<div class="viewcode-block" id="ITRF_to_TEME"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.ITRF_to_TEME">[docs]</a><span class="k">def</span> <span class="nf">ITRF_to_TEME</span><span class="p">(</span><span class="n">ITRF</span><span class="p">,</span> <span class="n">jd_ut1</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert ITRF position and velocity into the idiosyncratic</span>
<span class="sd">    True Equator Mean Equinox (TEME) frame of reference used by the SGP4</span>
<span class="sd">    theory.</span>

<span class="sd">    Modified work Copyright (c) 2019 Daniel Kastinen</span>

<span class="sd">    # TODO: There is some ambiguity about if this is ITRS00 or something else? I dont know.</span>

<span class="sd">    :param numpy.ndarray ITRF: 6-D state vector in ITRF frame given in SI-units.</span>
<span class="sd">    :param float jd_ut1: UT1 Julian date.</span>
<span class="sd">    :param float xp: Polar motion constant for rotation around x axis</span>
<span class="sd">    :param float yp: Polar motion constant for rotation around y axis</span>
<span class="sd">    :return: ITRF 6-D state vector given in SI-units.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ITRF</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rITRF</span> <span class="o">=</span> <span class="n">ITRF</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">vITRF</span> <span class="o">=</span> <span class="n">ITRF</span><span class="p">[</span><span class="mi">3</span><span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rITRF</span> <span class="o">=</span> <span class="n">ITRF</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">vITRF</span> <span class="o">=</span> <span class="n">ITRF</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">*</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span>

    <span class="n">theta</span><span class="p">,</span> <span class="n">theta_dot</span> <span class="o">=</span> <span class="n">theta_GMST1982</span><span class="p">(</span><span class="n">jd_ut1</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">theta_dot</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">angular_velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="o">-</span><span class="n">theta_dot</span><span class="p">])</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_z</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
        <span class="n">rPEF</span> <span class="o">=</span> <span class="n">rITRF</span>
        <span class="n">vPEF</span> <span class="o">=</span> <span class="n">vITRF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_y</span><span class="p">(</span><span class="o">-</span><span class="n">xp</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dpt</span><span class="o">.</span><span class="n">rot_mat_x</span><span class="p">(</span><span class="o">-</span><span class="n">yp</span><span class="p">))</span>
        <span class="n">rPEF</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rITRF</span><span class="p">)</span>
        <span class="n">vPEF</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vITRF</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rITRF</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rTEME</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rPEF</span><span class="p">)</span>
        <span class="n">vTEME</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vPEF</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">angular_velocity</span><span class="p">,</span> <span class="n">rPEF</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rTEME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij...,j...-&gt;i...&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">rPEF</span><span class="p">)</span>
        <span class="n">vTEME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij...,j...-&gt;i...&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">vPEF</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">angular_velocity</span><span class="p">,</span> <span class="n">rPEF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">TEME</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ITRF</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ITRF</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TEME</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">TEME</span><span class="p">[:</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rTEME</span>
        <span class="n">TEME</span><span class="p">[</span><span class="mi">3</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">vTEME</span><span class="o">/</span><span class="p">(</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">TEME</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rTEME</span>
        <span class="n">TEME</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vTEME</span><span class="o">/</span><span class="p">(</span><span class="mf">3600.0</span><span class="o">*</span><span class="mf">24.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TEME</span></div>


<span class="k">def</span> <span class="nf">_sgp4_elems2cart</span><span class="p">(</span><span class="n">kep</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Orbital elements to cartesian coordinates. Wrap DPT-function to use mean anomaly, km and reversed order on aoe and raan.</span>
<span class="sd">    </span>
<span class="sd">    Neglecting mass is sufficient for this calculation (the standard gravitational parameter is 24 orders larger then the change).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_kep</span> <span class="o">=</span> <span class="n">kep</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_kep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e3</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">_kep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">_kep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">_kep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="n">_kep</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">mean2true</span><span class="p">(</span><span class="n">_kep</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">_kep</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">radians</span><span class="o">=</span><span class="n">radians</span><span class="p">)</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">kep2cart</span><span class="p">(</span><span class="n">kep</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">M_cent</span><span class="o">=</span><span class="n">propagator_sgp4</span><span class="o">.</span><span class="n">M_earth</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="n">radians</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cart</span>

<span class="k">def</span> <span class="nf">_cart2sgp4_elems</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Cartesian coordinates to orbital elements. Wrap DPT-function to use mean anomaly, km and reversed order on aoe and raan.</span>
<span class="sd">    </span>
<span class="sd">    Neglecting mass is sufficient for this calculation (the standard gravitational parameter is 24 orders larger then the change).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kep</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">cart2kep</span><span class="p">(</span><span class="n">cart</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">M_cent</span><span class="o">=</span><span class="n">propagator_sgp4</span><span class="o">.</span><span class="n">M_earth</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="n">radians</span><span class="p">)</span>
    <span class="n">kep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e-3</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">kep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">kep</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">kep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">kep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="n">kep</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpt</span><span class="o">.</span><span class="n">true2mean</span><span class="p">(</span><span class="n">kep</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">kep</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">radians</span><span class="o">=</span><span class="n">radians</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kep</span>



<div class="viewcode-block" id="TEME_to_TLE_OPTIM"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.TEME_to_TLE_OPTIM">[docs]</a><span class="k">def</span> <span class="nf">TEME_to_TLE_OPTIM</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mjd0</span><span class="p">,</span> <span class="n">kepler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">tol_v</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert osculating orbital elements in TEME</span>
<span class="sd">    to mean elements used in two line element sets (TLE&#39;s).</span>

<span class="sd">    :param numpy.ndarray kep: Osculating State (position and velocity) vector in km and km/s, TEME frame. If :code:`kepler = True` then state is osculating orbital elements, in km and radians. Orbital elements are semi major axis (km), orbital eccentricity, orbital inclination (radians), right ascension of ascending node (radians), argument of perigee (radians), mean anomaly (radians)</span>
<span class="sd">    :param bool kepler: Indicates if input state is kepler elements or cartesian.</span>
<span class="sd">    :param float mjd0: Modified Julian date for state, important for SDP4 iteration.</span>
<span class="sd">    :param float tol: Wanted precision in position of mean element conversion in km.</span>
<span class="sd">    :param float tol_v: Wanted precision in velocity mean element conversion in km/s.</span>
<span class="sd">    :param str method: Forces use of SGP4 or SDP4 depending on string &#39;n&#39; or &#39;d&#39;, if None method is automatically chosen based on orbital period.</span>
<span class="sd">    :return: mean elements of: semi major axis (km), orbital eccentricity, orbital inclination (radians), right ascension of ascending node (radians), argument of perigee (radians), mean anomaly (radians)</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">kepler</span><span class="p">:</span>
        <span class="n">state_cart</span> <span class="o">=</span> <span class="n">_sgp4_elems2cart</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state_cart</span> <span class="o">=</span> <span class="n">state</span>
    
    <span class="n">init_elements</span> <span class="o">=</span> <span class="n">_cart2sgp4_elems</span><span class="p">(</span><span class="n">state_cart</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_mean_elems</span><span class="p">(</span><span class="n">mean_elements</span><span class="p">):</span>
        <span class="c1"># Mean elements and osculating state</span>
        <span class="n">state_osc</span> <span class="o">=</span> <span class="n">propagator_sgp4</span><span class="o">.</span><span class="n">sgp4_propagation</span><span class="p">(</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">mean_elements</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

        <span class="c1"># Correction of mean state vector</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">state_cart</span> <span class="o">-</span> <span class="n">state_osc</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)]</span><span class="o">*</span><span class="mi">3</span>

    <span class="n">opt_res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">find_mean_elems</span><span class="p">,</span> <span class="n">init_elements</span><span class="p">,</span>
        <span class="c1">#method=&#39;powell&#39;,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tol</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">tol_v</span><span class="o">**</span><span class="mi">2</span><span class="p">)}</span>
    <span class="p">)</span>
    <span class="n">mean_elements</span> <span class="o">=</span> <span class="n">opt_res</span><span class="o">.</span><span class="n">x</span>

    <span class="k">return</span> <span class="n">mean_elements</span></div>



<div class="viewcode-block" id="TEME_to_TLE"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.TEME_to_TLE">[docs]</a><span class="k">def</span> <span class="nf">TEME_to_TLE</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mjd0</span><span class="p">,</span> <span class="n">kepler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">tol_v</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert osculating orbital elements in TEME</span>
<span class="sd">    to mean elements used in two line element sets (TLE&#39;s).</span>

<span class="sd">    :param numpy.ndarray kep: Osculating State (position and velocity) vector in km and km/s, TEME frame. If :code:`kepler = True` then state is osculating orbital elements, in km and radians. Orbital elements are semi major axis (km), orbital eccentricity, orbital inclination (radians), right ascension of ascending node (radians), argument of perigee (radians), mean anomaly (radians)</span>
<span class="sd">    :param bool kepler: Indicates if input state is kepler elements or cartesian.</span>
<span class="sd">    :param float mjd0: Modified Julian date for state, important for SDP4 iteration.</span>
<span class="sd">    :param float tol: Wanted precision in position of mean element conversion in km.</span>
<span class="sd">    :param float tol_v: Wanted precision in velocity mean element conversion in km/s.</span>
<span class="sd">    :return: mean elements of: semi major axis (km), orbital eccentricity, orbital inclination (radians), right ascension of ascending node (radians), argument of perigee (radians), mean anomaly (radians)</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">kepler</span><span class="p">:</span>
        <span class="n">state_mean</span> <span class="o">=</span> <span class="n">_sgp4_elems2cart</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">state_kep</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">state_cart</span> <span class="o">=</span> <span class="n">state_mean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state_mean</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">state_cart</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">state_kep</span> <span class="o">=</span> <span class="n">_cart2sgp4_elems</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#method        : Forces use of SGP4 or SDP4 depending on string &#39;n&#39; or &#39;d&#39;, None is automatic method</span>
    <span class="c1"># Fix used model (SGP or SDP)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">state_kep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">propagator_sgp4</span><span class="o">.</span><span class="n">SGP4</span><span class="o">.</span><span class="n">GM</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span>
    <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mf">220.0</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">iter_max</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># Maximum number of iterations</span>

    <span class="c1"># Iterative determination of mean elements</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iter_max</span><span class="p">):</span>
        <span class="c1"># Mean elements and osculating state</span>
        <span class="n">mean_elements</span> <span class="o">=</span> <span class="n">_cart2sgp4_elems</span><span class="p">(</span><span class="n">state_mean</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mean_elements</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#Assumptions of osculation within slope not working, go to general minimization algorithms</span>
            <span class="n">mean_elements</span> <span class="o">=</span> <span class="n">TEME_to_TLE_OPTIM</span><span class="p">(</span><span class="n">state_cart</span><span class="p">,</span> <span class="n">mjd0</span><span class="o">=</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">kepler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">tol_v</span><span class="o">=</span><span class="n">tol_v</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">state_osc</span> <span class="o">=</span> <span class="n">propagator_sgp4</span><span class="o">.</span><span class="n">sgp4_propagation</span><span class="p">(</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">mean_elements</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

        <span class="c1"># Correction of mean state vector</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">state_cart</span> <span class="o">-</span> <span class="n">state_osc</span>
        <span class="n">state_mean</span> <span class="o">+=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dr_old</span> <span class="o">=</span> <span class="n">dr</span>
            <span class="n">dv_old</span> <span class="o">=</span> <span class="n">dv</span>

        <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># Position change</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>  <span class="c1"># Velocity change</span>

        <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dr_old</span> <span class="o">&lt;</span> <span class="n">dr</span> <span class="ow">or</span> <span class="n">dv_old</span> <span class="o">&lt;</span> <span class="n">dv</span><span class="p">:</span>
                <span class="c1">#Assumptions of osculation within slope not working, go to general minimization algorithms</span>
                <span class="n">mean_elements</span> <span class="o">=</span> <span class="n">TEME_to_TLE_OPTIM</span><span class="p">(</span><span class="n">state_cart</span><span class="p">,</span> <span class="n">mjd0</span><span class="o">=</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">kepler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">tol_v</span><span class="o">=</span><span class="n">tol_v</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">dr</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">dv</span> <span class="o">&lt;</span> <span class="n">tol_v</span><span class="p">:</span>   <span class="c1"># Iterate until position changes by less than eps</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="n">iter_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#Iterative method not working, go to general minimization algorithms</span>
            <span class="n">mean_elements</span> <span class="o">=</span> <span class="n">TEME_to_TLE_OPTIM</span><span class="p">(</span><span class="n">state_cart</span><span class="p">,</span> <span class="n">mjd0</span><span class="o">=</span><span class="n">mjd0</span><span class="p">,</span> <span class="n">kepler</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">tol_v</span><span class="o">=</span><span class="n">tol_v</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_elements</span></div>


<div class="viewcode-block" id="tle_id"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.tle_id">[docs]</a><span class="k">def</span> <span class="nf">tle_id</span><span class="p">(</span><span class="n">line1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extracts the Satellite number from the first line of a TLE.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">line1</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span></div>


<div class="viewcode-block" id="tle_bstar"><a class="viewcode-back" href="../modules/TLE_tools.html#TLE_tools.tle_bstar">[docs]</a><span class="k">def</span> <span class="nf">tle_bstar</span><span class="p">(</span><span class="n">line1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Extracts the BSTAR drag coefficient as a float from the first line of a TLE.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">bstar</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line1</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">59</span><span class="p">])</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line1</span><span class="p">[</span><span class="mi">59</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">bstar</span><span class="o">*</span><span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/conventions.html">Coordinate conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/more_dependencies.html">Optional dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/propagators.html">Installing propagators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/step_by_step.html">Step by step guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage_examples.html">Usage examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/doc.html">Documentation</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SORTS++ 3.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Daniel Kastinen, Juha Vierinen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>