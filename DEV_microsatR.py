#!/usr/bin/env python

import os
import time
import scipy.constants as consts
import numpy as np
import matplotlib.pyplot as plt

import population_library as plib 
import radar_library as rlib

import propagator_sgp4
import propagator_orekit


import TLE_tools as tle
import dpt_tools as dpt
from sorts_config import p as default_propagator

_prop = propagator_orekit.PropagatorOrekit
_opts = {
    'in_frame': 'TEME',
    'out_frame': 'ITRF',
    'solar_activity_strength': 'WEAK',
}

dt = np.datetime64('2019-04-02T12:01')
mjd = dpt.npdt2mjd(dt)

pop = plib.simulate_Microsat_R_debris_v2(
    num = 10,
    max_dv = 1e3,
    rho_range = [1000.0, 8000.0],
    mass_range = [0.005, 1.0],
    seed = 123546,
    propagator = _prop,
    propagator_options = _opts,
    mjd = mjd,
)

print(pop)

exit()




pop = plib.Microsat_R_debris_TLE(mjd)

obj = pop.get_object(0)

print(pop)

print(obj)

exit()









tle_raw = '''1 43947U 19006A   19069.62495353  .00222140  22344-4  39735-3 0  9995
2 43947  96.6263 343.1609 0026772 226.5664 224.4731 16.01032328  7176
1 43947U 19006A   19069.68634861  .00217235  21442-4  38851-3 0  9995
2 43947  96.6282 343.2231 0026267 227.5469 217.1086 16.01062873  7183
1 43947U 19006A   19069.81093322  .00066734  37128-5  12017-3 0  9992
2 43947  96.6282 343.3467 0026246 227.0726 215.1493 16.01048534  7204
1 43947U 19006A   19070.54563657  .00111882  69857-5  20248-3 0  9991
2 43947  96.6271 344.0664 0025783 228.7058 125.4384 16.00925959  7318
1 43947U 19006A   19070.80923755  .00013653  19858-5  25403-4 0  9991
2 43947  96.6268 344.3320 0024927 225.1848 207.3499 16.01142181  7364
1 43947U 19006A   19071.12831853  .00154965  11740-4  27719-3 0  9998
2 43947  96.6279 344.6467 0025572 226.6832 243.5148 16.01113233  7412
1 43947U 19006A   19071.80921646  .00118874  76545-5  21379-3 0  9993
2 43947  96.6279 345.3224 0025491 224.0468 208.0149 16.01043615  7523
1 43947U 19006A   19072.44153689  .00037015  24665-5  66863-4 0  9999
2 43947  96.6279 345.9498 0025442 221.6016 252.7257 16.01159223  7620
1 43947U 19006A   19072.74405995  .00022228  21113-5  40609-4 0  9997
2 43947  96.6279 346.2500 0025432 220.3955 196.4626 16.01147542  7675
1 43947U 19006A   19073.12825718  .00008242  19370-5  15873-4 0  9996
2 43947  96.6304 346.6133 0023002 223.0617 246.6563 16.01114545  7738
1 43947U 19006A   19073.44154376  .00035052  24102-5  63784-4 0  9998
2 43947  96.6300 346.9244 0022588 225.2511 249.1037 16.01188227  7782
1 43947U 19006A   19073.80920446 -.00023017  21041-5 -40417-4 0  9994
2 43947  96.6337 347.2908 0022039 223.4278 208.5467 16.01076766  7841
1 43947U 19006A   19074.74408622  .00119327  76982-5  21614-3 0  9994
2 43947  96.6289 348.2321 0022856 222.6623 194.1149 16.01049775  7992
1 43947U 19006A   19075.01672454  .00167822  13470-4  30180-3 0  9994
2 43947  96.6290 348.5015 0022778 221.4659 325.7020 16.01154108  8039
1 43947U 19006A   19075.54702546  .00026769  22010-5  48973-4 0  9993
2 43947  96.6290 349.0278 0022754 219.3583 142.5100 16.01177853  8128
1 43947U 19006A   19075.74902949  .00160298  12418-4  29196-3 0  9995
2 43947  96.6301 349.2308 0021693 223.2409 221.9908 16.00986874  8150
1 43947U 19006A   19075.80608134  .00151204  11245-4  27527-3 0  9991
2 43947  96.6283 349.2862 0021642 222.7701 191.0541 16.01000711  8166
1 43947U 19006A   19075.80608134  .00152613  11422-4  27780-3 0  9994
2 43947  96.6283 349.2862 0021642 222.7701 191.0553 16.01002279  8160
1 43947U 19006A   19076.04950662  .00212767  20643-4  38419-3 0  9990
2 43947  96.6283 349.5277 0021615 221.8443 154.0766 16.01125308  8205
1 43947U 19006A   19076.38314227  .00228397  23614-4  40852-3 0  9999
2 43947  96.6283 349.8588 0021611 220.6464 277.1313 16.01285801  8254
1 43947U 19006A   19076.56965602  .00375665  62286-4  68387-3 0  9990
2 43947  96.6317 350.0396 0020897 222.9971 269.0493 16.01007118  8281
1 43947U 19006A   19076.62489356  .00301460  40170-4  54811-3 0  9991
2 43947  96.6317 350.0945 0020879 222.7479 227.4454 16.01029701  8290
1 43947U 19006A   19076.74888822  .00206456  19517-4  37455-3 0  9990
2 43947  96.6317 350.2206 0020779 222.3519 222.0257 16.01081824  8311
1 43947U 19006A   19076.80334391  .00189842  16753-4  34417-3 0  9997
2 43947  96.6317 350.2747 0020760 222.1378 175.8977 16.01098177  8326
1 43947U 19006A   19077.25548485  .00042586  26475-5  77957-4 0  9991
2 43947  96.6337 350.7139 0018680 228.2848 254.2224 16.01199217  8396
1 43947U 19006A   19077.49923692  .00048049  28483-5  87602-4 0  9993
2 43947  96.6337 350.9559 0018675 227.3154 219.3457 16.01241589  8433
1 43947U 19006A   19077.73867148  .00176479  14671-4  32436-3 0  9999
2 43947  96.6324 351.1992 0019599 225.2817 160.3011 16.00913438  8475
1 43947U 19006A   19078.62402633  .00193781  17362-4  35487-3 0  9996
2 43947  96.6337 352.0814 0019337 224.7610 220.1468 16.00981700  8611
1 43947U 19006A   19079.44446882  .00056887  32197-5  10424-3 0  9994
2 43947  96.6318 352.8859 0017932 222.6020 267.9762 16.01149860  8742
1 43947U 19006A   19079.56114259  .00331197  48376-4  60603-3 0  9996
2 43947  96.6357 353.0133 0018767 223.2624 219.3325 16.01004143  8769
1 43947U 19006A   19079.87121502  .00017670  20377-5  33169-4 0  9996
2 43947  96.6348 353.3097 0018626 221.5456 207.0221 16.01103300  8819
1 43947U 19006A   19080.12837572  .00018161  20446-5  34105-4 0  9991
2 43947  96.6342 353.5628 0017856 223.7454 246.0274 16.01109643  8852
1 43947U 19006A   19080.25184005  .00021666  21015-5  40443-4 0  9990
2 43947  96.6342 353.6854 0017855 223.2528 237.6932 16.01123784  8871
1 43947U 19006A   19080.56838169  .00007182  19289-5  14116-4 0  9996
2 43947  96.6323 353.9969 0018497 223.3308 260.9364 16.01125965  8927
1 43947U 19006A   19080.80934521 -.00010028  19397-5 -17132-4 0  9998
2 43947  96.6323 354.2362 0018496 222.3649 209.7823 16.01086764  8962
1 43947U 19006A   19081.01817130 -.00000602  19026-5  00000+0 0  9994
2 43947  96.6305 354.4520 0018602 217.7557 337.0831 16.00999357  8992
1 43947U 19006A   19081.19970958  .00192780  17239-4  35047-3 0  9995
2 43947  96.6332 354.6387 0017808 222.1497 298.3751 16.01166044  9020
1 43947U 19006A   19081.44288380  .00132357  90623-5  24030-3 0  9997
2 43947  96.6332 354.8802 0017799 221.2143 260.0465 16.01211967  9068
1 43947U 19006A   19081.68209472  .00185493  16056-4  34001-3 0  9993
2 43947  96.6354 355.1161 0017576 220.8387 198.1644 16.01033820  9107
1 43947U 19006A   19081.80977756  .00126608  84347-5  23219-3 0  9995
2 43947  96.6356 355.2444 0017575 222.5408 211.8678 16.01049036  9124
1 43947U 19006A   19082.19785193  .00009851  19489-5  19026-4 0  9997
2 43947  96.6356 355.6299 0017571 221.0666 288.6619 16.01097025  9186
1 43947U 19006A   19082.25710510  .00009887  19472-5  19026-4 0  9996
2 43947  96.6318 355.6880 0017118 220.4674 270.5748 16.01171238  9192
1 43947U 19006A   19082.38407701  .00138221  97199-5  25077-3 0  9994
2 43947  96.6325 355.8124 0017241 219.6702 282.7837 16.01240682  9219
1 43947U 19006A   19082.68646591  .00149753  11067-4  27555-3 0  9993
2 43947  96.6363 356.1139 0016876 222.4115 221.6813 16.01004284  9261
1 43947U 19006A   19082.81114447  .00088395  50732-5  16304-3 0  9995
2 43947  96.6363 356.2377 0016873 221.9425 220.2429 16.01009980  9289
1 43947U 19006A   19083.00642146  .00143972  10375-4  26369-3 0  9992
2 43947  96.6358 356.4314 0016878 221.0757 265.8708 16.01087252  9317
1 43947U 19006A   19083.49288397 -.03265362  32488-2 -61588-2 0  9990
2 43947  96.6406 356.9162 0017256 219.6745 189.3161 16.00630469  9392
1 43947U 19006A   19083.74911125  .00084825  48174-5  15749-3 0  9999
2 43947  96.6345 357.1709 0015989 224.4362 220.2191 16.00930159  9436
1 43947U 19006A   19083.81116759  .00103815  62739-5  19235-3 0  9995
2 43947  96.6324 357.2279 0015947 223.4735 218.5865 16.00945210  9446
1 43947U 19006A   19083.93495759  .00147725  10814-4  27243-3 0  9990
2 43947  96.6324 357.3507 0015945 222.9977 212.0347 16.00998010  9463
1 43947U 19006A   19084.04992207  .00154144  11623-4  28342-3 0  9996
2 43947  96.6354 357.4673 0016254 222.4775 154.7117 16.01036332  9486
1 43947U 19006A   19084.56994306 -.00389064  56746-4 -71643-3 0  9995
2 43947  96.6360 357.9786 0015819 222.1151 270.2904 16.00942425  9569
1 43947U 19006A   19084.68712708  .00107795  66250-5  19877-3 0  9992
2 43947  96.6366 358.0976 0015957 221.7662 225.5779 16.01024149  9583
1 43947U 19006A   19084.74556389  .00097765  57838-5  18034-3 0  9991
2 43947  96.6363 358.1566 0015910 221.6645 202.2537 16.01028963  9598
1 43947U 19006A   19084.98720666  .00152043  11367-4  27860-3 0  9992
2 43947  96.6362 358.3958 0015832 220.6056 155.1371 16.01110841  9636
1 43947U 19006A   19085.19976117  .00022830  21215-5  42802-4 0  9998
2 43947  96.6349 358.6073 0016094 221.4560 298.5857 16.01085713  9665
1 43947U 19006A   19085.49952644  .00052661  30351-5  96803-4 0  9996
2 43947  96.6377 358.9036 0016197 221.8414 224.9544 16.01169686  9718
1 43947U 19006A   19085.56842683  .00054526  31167-5  10000-3 0  9997
2 43947  96.6377 358.9720 0016198 221.5803 262.1287 16.01202917  9722
1 43947U 19006A   19085.80962006  .00050945  29637-5  93510-4 0  9994
2 43947  96.6379 359.2115 0016283 220.5574 212.4511 16.01198803  9765'''

mass = 740

tle_raw = [line.strip() for line in tle_raw.split('\n')]
if len(tle_raw) % 2 != 0:
    raise Exception('Not even number of lines [not TLE compatible]')
TLEs = zip(tle_raw[0::2], tle_raw[1::2])

event_date = np.datetime64('2019-03-27T05:40')
event_mjd = dpt.npdt2mjd(event_date)

M_earth = propagator_sgp4.SGP4.GM*1e9/consts.G


tle_mjds = np.empty((len(TLEs),), dtype=np.float64)
for line_id, lines in enumerate(TLEs):
    line1, line2 = lines
    jd0 = tle.tle_jd(line1)
    mjd0 = dpt.jd_to_mjd(jd0)
    tle_mjds[line_id] = mjd0

best_tle = np.argmin(np.abs(tle_mjds - event_mjd))


line1, line2 = TLEs[best_tle]
sat_id = tle.tle_id(line1)
jd0 = tle.tle_jd(line1)
mjd0 = dpt.jd_to_mjd(jd0)

state_TEME = tle.TLE_propagation_TEME(line1, line2, dpt.mjd_to_jd(event_mjd))

kep = dpt.cart2kep(state_TEME, m=mass, M_cent=M_earth, radians=False)

print('{}'.format(kep[0,0]))
print('{}'.format(kep[1,0]))
print('{}'.format(kep[2,0]))
print('{}'.format(kep[3,0]))
print('{}'.format(kep[4,0]))
print('{}'.format(kep[5,0]))

'''

os.environ['TZ'] = 'GMT'
time.tzset()

dt = np.datetime64('2019-04-02T12:01')
mjd = dpt.npdt2mjd(dt)


pop = plib.Microsat_R_debris(
    mjd = mjd,
    num=10,
    radii_range=[0.025, 0.5],
    mass_range=[0.05, 10.0],
    propagator = default_propagator,
    propagator_options = {},
)

print(pop)
'''